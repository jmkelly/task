@page
@using Task.Api.Pages
@model IndexModel
@{
    ViewData["Title"] = "Kanban Board";
}

<!-- Hero-style header with gradient background -->
<section class="hero-section">
    <div class="hero-container">
        <div class="hero-content">
            <h1><span class="emoji emoji-leading">ğŸš€</span>Task Board</h1>
            <p class="header-subtitle">Manage your workflow with drag-and-drop simplicity</p>
        </div>
        <div class="hero-actions">
            <button class="btn-primary" hx-get="/Index?handler=CreateModal" hx-target="body" hx-swap="beforeend">
                <span class="emoji emoji-leading">â•</span>Add Task
            </button>
            <button class="btn-secondary" hx-post="/Index?handler=ClearBoard" hx-target="#board" hx-swap="innerHTML" onclick="return confirm('Are you sure you want to clear all tasks? This action cannot be undone.')">
                <span class="emoji emoji-leading">ğŸ—‘ï¸</span>Clear Board
            </button>
        </div>
    </div>
</section>

<!-- Main board container with HTMX polling -->
<section class="board-section">
    <div id="board" class="board-surface" hx-get="/Index?handler=Refresh" hx-trigger="every 1s" hx-target="#board" hx-swap="innerHTML">
        @await Html.PartialAsync("_KanbanBoard", Model.TaskItems)
    </div>
</section>

<!-- Modal container for task creation -->
<div id="modal-container"></div>

@Html.AntiForgeryToken()

@section Scripts {
    <script>
        document.addEventListener('htmx:configRequest', function(evt) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                evt.detail.headers['RequestVerificationToken'] = token.value;
            }
        });

        let draggedElement = null;

        function handleDragStart(event) {
            draggedElement = event.target;
            event.target.classList.add('dragging');
            event.dataTransfer.setData('text/plain', event.target.dataset.uid);
        }

        function handleDrop(event) {
            event.preventDefault();
            const uid = event.dataTransfer.getData('text/plain');
            const status = event.currentTarget.closest('.kanban-column').dataset.status;

            if (uid && status && draggedElement) {
                // Remove dragging class
                draggedElement.classList.remove('dragging');

                // Send HTMX request
                htmx.ajax('POST', '/Index?handler=UpdateStatus', {
                    values: { uid: uid, status: status },
                    target: '#board',
                    swap: 'innerHTML'
                });
            }
        }

        // Initialize drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            // Add drag over effects
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                const column = e.target.closest('.kanban-column');
                if (column) {
                    column.classList.add('drag-over');
                }
            });

            document.addEventListener('dragleave', function(e) {
                const column = e.target.closest('.kanban-column');
                if (column && !column.contains(e.relatedTarget)) {
                    column.classList.remove('drag-over');
                }
            });

            document.addEventListener('drop', function(e) {
                // Remove all drag-over classes
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('drag-over');
                });
            });

            // Clean up on drag end
            document.addEventListener('dragend', function(e) {
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('drag-over');
                });
            });
        });
    </script>
}
